@using BlazorApp2.DB
@using Microsoft.EntityFrameworkCore
@inject User02Context db

<div class="container">
    <div class="text-center"><b>Календарь событий</b></div>
    <div class="row bg-success ">
        <div class="col-sm-2" onclick="@(()=>AddMonth(-1))">&lt;</div>
        <div class="col-sm-8 text-center">@month</div>
        <div class="col-sm-2" onclick="@(()=>AddMonth(1))">&gt;</div>
    </div>
    <div class="row">
        <table class="align-items-center">
            <thead>
                <tr>
                    <th>п</th>
                    <th>в</th>
                    <th>с</th>
                    <th>ч</th>
                    <th>п</th>
                    <th>с</th>
                    <th>в</th>
                </tr>
            </thead>
            <tbody>
                @while (dayIndex <= dayCount)
                {
                    <tr>
                        @for (int i = 1; i <= 7; i++)
                        {
                            @switch (PrintDay(i))
                            {
                                case 0:
                                    <td></td>
                                    break;
                                case 1:
                                    <td>@(dayIndex - 1)</td>
                                    break;
                                case 2:
                                    <td Title="@GetCakeTooltipStyle(dayIndex - 1)">
                                        <img src="cake.png" width="20" />
                                    </td>
                                    break;
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    string month = "";
    DateTime selectedDate;
    DateTime currentDate;
    DateTime firstDate;

    int dayCount = 0;
    int dayIndex = 0;
    int weekDay = 0;

    [Parameter]
    public List<Employee> Employees { get; set; }



    protected override async Task OnInitializedAsync()
    {
        currentDate = DateTime.Now;
        SetDate(currentDate);
        await base.OnInitializedAsync();
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        SetDate(selectedDate);
        return base.OnAfterRenderAsync(firstRender);
    }


    void SetDate(DateTime date)
    {
        selectedDate = date;
        month = date.ToString("MMMM");

        dayCount = DateTime.DaysInMonth(date.Year, date.Month);
        firstDate = new DateTime(date.Year, date.Month, 1);
        weekDay = (int)firstDate.DayOfWeek;
        if (weekDay == 0)
            weekDay = 7;
        dayIndex = 1;
        print = false;
    }

    void AddMonth(int count)
    {
        selectedDate = selectedDate.AddMonths(count);
        selectedDate = new DateTime(selectedDate.Year, selectedDate.Month, 1);
        SetDate(selectedDate);
    }

    bool print = false;
    int PrintDay(int indexWeek)
    {
        if (!print)
        {
            if (weekDay == indexWeek)
                print = true;
        }
        if (print)
        {
            if (dayIndex <= dayCount)
            {
                if (Employees.FirstOrDefault(s => 
                    s.BirthdayDate != null &&
                    s.BirthdayDate.Value.Day == dayIndex &&
                    s.BirthdayDate.Value.Month == selectedDate.Month) != null)
                {
                    dayIndex++;
                    return 2; 
                }
                else
                {
                    dayIndex++;
                    return 1;
                }
            }
        }
        return 0;
    }

    string GetCakeTooltipStyle(int day)
    {
        var workers = Employees.Where(s =>
                    s.BirthdayDate != null &&
                    s.BirthdayDate.Value.Day == day &&
                    s.BirthdayDate.Value.Month == selectedDate.Month).
                    Select(s => s.LastName).ToList();

        return string.Join(' ', workers);
    }
}
